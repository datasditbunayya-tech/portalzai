<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portal Pendidikan Bunayya Islamic School</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body { font-family: 'Segoe UI', sans-serif; }
    
    .toast {
      position: fixed; top: 20px; right: 20px;
      padding: 16px 24px; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 9999; animation: slideIn 0.3s ease-out;
      display: flex; align-items: center; gap: 10px;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .toast-success { background: #10b981; color: white; }
    .toast-error { background: #ef4444; color: white; }
    .toast-info { background: #3b82f6; color: white; }

    .role-btn.active { background-color: #4F46E5; color: white; }
    
    .input-field {
      width: 100%; padding: 0.5rem; border: 1px solid #d1d5db;
      border-radius: 0.375rem; margin-top: 0.25rem; font-size: 0.9rem;
    }
    .input-field:focus { outline: none; border-color: #4F46E5; }

    .wali-tab-btn.active { background-color: white; color: #4F46E5; border-bottom: 2px solid #4F46E5; font-weight: bold; }
    .wali-tab-btn { background-color: #f3f4f6; color: #6b7280; }

    .loading-overlay {
      position: fixed; inset: 0; background: rgba(255,255,255,0.9);
      display: none; align-items: center; justify-content: center; z-index: 10000;
      flex-direction: column;
    }
    .spinner {
      border: 4px solid #f3f4f6; border-top: 4px solid #4F46E5;
      border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="h-full bg-gray-50 flex flex-col">

  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner mb-4"></div>
    <p class="text-gray-600 font-medium">Menghubungkan ke Google Sheets...</p>
  </div>

  <header class="bg-white shadow-md z-50">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
            <i class="fas fa-school text-2xl text-indigo-600"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-gray-800">Portal Bunayya</h1>
            <p class="text-xs text-gray-500">Sistem Informasi Sekolah</p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <div class="flex bg-gray-100 p-1 rounded-lg">
            <button onclick="setRole('siswa')" id="btn-role-siswa" class="role-btn px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-600 hover:bg-gray-200">Siswa</button>
            <button onclick="setRole('guru')" id="btn-role-guru" class="role-btn px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-600 hover:bg-gray-200">Guru</button>
            <button onclick="setRole('wali')" id="btn-role-wali" class="role-btn px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-600 hover:bg-gray-200">Wali</button>
            <button onclick="setRole('admin')" id="btn-role-admin" class="role-btn px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-600 hover:bg-gray-200">Admin</button>
          </div>
          <button onclick="showSetupModal()" class="text-gray-500 hover:text-indigo-600 p-2 rounded-full bg-gray-100" title="Setup Connection">
            <i class="fas fa-cog"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-1 overflow-auto p-4 md:p-6">
    
    <!-- SISWA -->
    <section id="view-siswa" class="hidden max-w-5xl mx-auto space-y-6 fade-in">
      <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
        <h3 class="font-bold text-gray-700 mb-3"><i class="fas fa-filter mr-2"></i>Identitas Siswa</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm text-gray-600">Pilih Kelas</label>
            <select id="siswa-filter-kelas" onchange="loadSiswaData()" class="input-field">
              <option value="">Pilih Kelas...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-600">Nama Siswa</label>
            <select id="siswa-filter-nama" onchange="loadSiswaData()" class="input-field">
              <option value="">-- Pilih Siswa --</option>
            </select>
          </div>
          <div class="flex items-end">
             <button onclick="loadSiswaData()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 w-full">Refresh Data</button>
          </div>
        </div>
      </div>
      <div id="siswa-content-area">
        <p class="text-gray-500 text-center py-10">Silakan pilih Kelas dan Nama Siswa untuk melihat data.</p>
      </div>
    </section>

    <!-- GURU -->
    <section id="view-guru" class="hidden max-w-6xl mx-auto space-y-6 fade-in">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
          <div class="text-gray-500 text-xs">Total Siswa</div>
          <div class="text-2xl font-bold text-gray-800" id="guru-total-siswa">-</div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col">
          <div class="flex items-center gap-2 mb-4 border-b pb-2">
            <i class="fas fa-book-open text-indigo-600"></i>
            <h3 class="font-bold text-gray-800 text-lg">Jurnal Mengajar</h3>
          </div>
          <form onsubmit="submitJurnal(event)" class="space-y-3 flex-1">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-semibold text-gray-500">Kelas</label>
                <select id="jurnal-kelas" class="input-field" required>
                  <option value="Kelas 5">Kelas 5</option>
                  <option value="Kelas 4">Kelas 4</option>
                </select>
              </div>
              <div>
                <label class="text-xs font-semibold text-gray-500">Mapel</label>
                <select id="jurnal-mapel" class="input-field" required>
                  <option value="Matematika">Matematika</option>
                  <option value="B. Indonesia">B. Indonesia</option>
                </select>
              </div>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-500">Topik</label>
              <input type="text" id="jurnal-topik" placeholder="Topik hari ini..." class="input-field" required>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-500">Catatan</label>
              <textarea id="jurnal-catatan" rows="3" class="input-field resize-none"></textarea>
            </div>
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 font-medium text-sm w-full">
              <i class="fas fa-save mr-1"></i> Kirim ke Server
            </button>
          </form>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col">
          <div class="flex items-center justify-between mb-4 border-b pb-2">
            <div class="flex items-center gap-2">
              <i class="fas fa-clipboard-check text-green-600"></i>
              <h3 class="font-bold text-gray-800 text-lg">Absensi Siswa</h3>
            </div>
            <select id="absen-kelas-select" onchange="loadAbsensiList()" class="text-xs border rounded p-1">
              <option value="Kelas 5">Kelas 5</option>
              <option value="Kelas 4">Kelas 4</option>
            </select>
          </div>
          <div id="absensi-list-container" class="flex-1 overflow-y-auto space-y-2 max-h-[380px] pr-2">
            <p class="text-center text-gray-400 py-4">Pilih kelas untuk memuat data siswa...</p>
          </div>
          <button onclick="submitAbsensi()" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm font-medium w-full">
            <i class="fas fa-save mr-1"></i> Simpan Absensi
          </button>
        </div>
      </div>
    </section>

    <!-- WALI -->
    <section id="view-wali" class="hidden max-w-5xl mx-auto space-y-6 fade-in">
      <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <h3 class="font-bold text-gray-700 mb-3">Monitoring Anak</h3>
        <div class="flex gap-4">
          <select id="wali-anak-select" class="input-field" onchange="loadWaliData()">
            <option value="">-- Pilih Anak --</option>
          </select>
          <button onclick="loadWaliData()" class="bg-orange-500 text-white px-6 rounded hover:bg-orange-600">Cek</button>
        </div>
      </div>
      <div id="wali-display-area">
        <p class="text-center text-gray-400 py-10">Silakan pilih nama anak.</p>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="view-admin" class="hidden max-w-7xl mx-auto space-y-6 fade-in">
      <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
        <h3 class="font-bold text-lg mb-4">Test Koneksi Google Sheets</h3>
        <button onclick="testConnection()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          Ping Server
        </button>
        <div id="connection-result" class="mt-4 p-4 bg-gray-50 rounded text-sm"></div>
      </div>
    </section>

  </main>

  <div id="setup-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10000] hidden flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">⚙️ Setup Google Sheets</h2>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">URL Google Apps Script *</label>
        <input type="text" id="script-url-input" placeholder="https://script.google.com/macros/s/..." 
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
          value="https://script.google.com/macros/s/AKfycbwXdMm9evDIsrzEeIA6nR6O-UWdeBWawsshgpgdHGRX1zMfgYpr1iPgIA6NrLLigz11hg/exec">
        <p class="text-xs text-gray-500 mt-1">URL ini akan digunakan untuk menyimpan & mengambil data.</p>
      </div>
      
      <div class="flex gap-2">
        <button onclick="saveScriptUrl()" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Simpan & Tes Koneksi</button>
        <button onclick="hideSetupModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">Tutup</button>
      </div>
    </div>
  </div>

  <script>
    let SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwXdMm9evDIsrzEeIA6nR6O-UWdeBWawsshgpgdHGRX1zMfgYpr1iPgIA6NrLLigz11hg/exec";
    let currentRole = 'siswa';
    let cachedData = { students: [], nilai: [], absensi: [] };

    document.addEventListener('DOMContentLoaded', () => {
      const savedUrl = localStorage.getItem('bunayya_script_url');
      if(savedUrl) {
        SCRIPT_URL = savedUrl;
        document.getElementById('script-url-input').value = savedUrl;
        testConnection();
      } else {
        showSetupModal();
      }
      setRole('siswa');
    });

    function showLoading() {
      document.getElementById('loading-overlay').style.display = 'flex';
    }
    function hideLoading() {
      document.getElementById('loading-overlay').style.display = 'none';
    }

    async function fetchData(action = 'getAll') {
      showLoading();
      try {
        const response = await fetch(`${SCRIPT_URL}?action=${action}`);
        const result = await response.json();
        hideLoading();
        if (result.success) return result.data;
        else { showToast('Gagal mengambil data: ' + result.error, 'error'); return null; }
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan koneksi', 'error');
        return null;
      }
    }

    async function sendData(data) {
      showLoading();
      try {
        const formData = new FormData();
        formData.append('action', 'create');
        formData.append('data', JSON.stringify(data));
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const result = await response.json();
        hideLoading();
        if (result.success) { showToast('Data berhasil disimpan!', 'success'); return true; }
        else { showToast('Gagal menyimpan: ' + result.error, 'error'); return false; }
      } catch (error) {
        hideLoading();
        showToast('Koneksi error saat simpan', 'error');
        return false;
      }
    }

    function setRole(role) {
      currentRole = role;
      document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`btn-role-${role}`).classList.add('active');
      ['view-siswa', 'view-guru', 'view-wali', 'view-admin'].forEach(id => { document.getElementById(id).classList.add('hidden'); });
      document.getElementById(`view-${role}`).classList.remove('hidden');
      if(role === 'siswa') loadSiswaStructure();
      if(role === 'guru') loadGuruStructure();
      if(role === 'wali') loadWaliStructure();
    }

    async function loadSiswaStructure() {
      if (cachedData.students.length === 0) {
        const data = await fetchData('getByType&type=master_siswa');
        if(data) cachedData.students = data;
      }
      const classSelect = document.getElementById('siswa-filter-kelas');
      const classes = [...new Set(cachedData.students.map(s => s.class_name))];
      classSelect.innerHTML = '<option value="">Pilih Kelas...</option>';
      classes.forEach(cls => {
        const opt = document.createElement('option');
        opt.value = cls; opt.textContent = cls;
        classSelect.appendChild(opt);
      });
    }

    async function loadSiswaData() {
      const kelas = document.getElementById('siswa-filter-kelas').value;
      const nama = document.getElementById('siswa-filter-nama').value;
      if(!kelas) return;
      const studentsInClass = cachedData.students.filter(s => s.class_name === kelas);
      const nameSelect = document.getElementById('siswa-filter-nama');
      nameSelect.innerHTML = '<option value="">-- Pilih Siswa --</option>';
      studentsInClass.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.nama; opt.textContent = s.nama;
        nameSelect.appendChild(opt);
      });
      if(nama) {
        const allNilai = await fetchData('getByType&type=nilai'); 
        if(allNilai) {
          const myNilai = allNilai.filter(n => n.student_name === nama && n.class_name === kelas);
          let html = `<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div class="px-6 py-4 border-b bg-gray-50"><h3 class="font-bold text-gray-800">Nilai: ${nama}</h3></div><table class="w-full text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-3">Mapel</th><th class="p-3">Nilai</th><th class="p-3">Catatan</th></tr></thead><tbody>${myNilai.map(n => `<tr class="border-b"><td class="p-3">${n.subject}</td><td class="p-3 font-bold">${n.score}</td><td class="p-3 text-gray-500">${n.notes}</td></tr>`).join('')}</tbody></table></div>`;
          document.getElementById('siswa-content-area').innerHTML = html || '<p class="text-center py-4">Tidak ada data nilai.</p>';
        }
      }
    }

    async function loadGuruStructure() {
      const students = await fetchData('getByType&type=master_siswa');
      if(students) {
        document.getElementById('guru-total-siswa').textContent = students.length;
        loadAbsensiList();
      }
    }

    async function loadAbsensiList() {
      const kelas = document.getElementById('absen-kelas-select').value;
      const students = await fetchData('getByType&type=master_siswa');
      if(!students) return;
      const filtered = students.filter(s => s.class_name === kelas);
      const container = document.getElementById('absensi-list-container');
      container.innerHTML = filtered.map(s => `<div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded border-b border-gray-100"><span class="text-sm font-medium text-gray-700">${s.nama}</span><select name="absen_${s.id}" class="text-xs border rounded p-1"><option value="Hadir">Hadir</option><option value="Sakit">Sakit</option><option value="Izin">Izin</option><option value="Alpa">Alpa</option></select></div>`).join('');
    }

    async function submitJurnal(e) {
      e.preventDefault();
      const data = {
        type: 'journal', teacher_name: 'Guru Demo', date: new Date().toISOString().split('T')[0],
        class_name: document.getElementById('jurnal-kelas').value, subject: document.getElementById('jurnal-mapel').value,
        topic: document.getElementById('jurnal-topik').value, notes: document.getElementById('jurnal-catatan').value,
        activity: 'Belajar di kelas', created_at: new Date().toISOString()
      };
      await sendData(data);
    }

    async function submitAbsensi() {
      const kelas = document.getElementById('absen-kelas-select').value;
      const students = await fetchData('getByType&type=master_siswa');
      const filtered = students.filter(s => s.class_name === kelas);
      let count = 0;
      for (const s of filtered) {
        const status = document.querySelector(`select[name="absen_${s.id}"]`).value;
        const data = {
          type: 'student_attendance', class_name: kelas, student_name: s.nama, nis: s.nis,
          date: new Date().toISOString().split('T')[0], status: status, created_at: new Date().toISOString()
        };
        const success = await sendData(data);
        if(success) count++;
      }
      if(count > 0) showToast(`${count} data absensi terkirim`, 'success');
    }

    async function loadWaliStructure() {
      const students = await fetchData('getByType&type=master_siswa');
      if(!students) return;
      const select = document.getElementById('wali-anak-select');
      select.innerHTML = '<option value="">-- Pilih Anak --</option>';
      students.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.nama; opt.textContent = `${s.nama} (${s.class_name})`;
        select.appendChild(opt);
      });
    }

    async function loadWaliData() {
      const nama = document.getElementById('wali-anak-select').value;
      if(nama) {
        document.getElementById('wali-display-area').innerHTML = `<div class="p-4 bg-white rounded shadow">Menampilkan data untuk ${nama}</div>`;
      }
    }

    async function testConnection() {
      const resultDiv = document.getElementById('connection-result');
      resultDiv.innerHTML = '<span class="text-blue-500">Menghubungkan...</span>';
      const data = await fetchData('getAll');
      if(data) {
        resultDiv.innerHTML = `<span class="text-green-600 font-bold">✅ Terhubung!</span> Data ditemukan: ${data.length} baris.`;
      } else {
        resultDiv.innerHTML = `<span class="text-red-600 font-bold">❌ Gagal Terhubung.</span> Cek URL Anda.`;
      }
    }

    function showToast(msg, type) {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':type==='error'?'times-circle':'info-circle'}"></i> <span>${msg}</span>`;
      document.body.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
    }

    function showSetupModal() { document.getElementById('setup-modal').classList.remove('hidden'); }
    function hideSetupModal() { document.getElementById('setup-modal').classList.add('hidden'); }
    
    function saveScriptUrl() {
      const url = document.getElementById('script-url-input').value.trim();
      if(!url) return showToast('URL tidak boleh kosong', 'error');
      SCRIPT_URL = url;
      localStorage.setItem('bunayya_script_url', url);
      hideSetupModal();
      showToast('URL tersimpan. Menguji koneksi...', 'info');
      testConnection();
    }
  </script>
</body>
</html>